# Задачник с командной работой - План разработки

## Ⅰ. Общая настройка и анализ
- [x] Проанализировать загруженную структуру проекта.
- [x] Изучить `schema.sql` для понимания структуры БД.
- [x] Изучить `db.php` для понимания подключения к БД.
- [x] Переместить файлы проекта из `uploads/Fix-and-Update-API-Task/` в корень.
- [x] Убедиться в корректности путей к `db.php` в файлах папки `api`.
- [x] Удалить дублирующий/устаревший файл `api/task.php` (используется `api/tasks.php`).
- [x] Заменить неформальные тексты на главной странице (`index.php`).
- [ ] Просмотреть основные PHP файлы (`login.php`, `register.php`, `dashboard.php`, `tasks.php`) для оценки текущего функционала и возможных PHP ошибок.
- [ ] Проанализировать `api/auth.php` и `login.php` для понимания процесса аутентификации.
- [x] Проанализировать `api/users.php` и `js/tasks.js` (связанные с `loadUsers()`):
    - [x] Исправлена уязвимость в `api/users.php` (не возвращать хеш пароля).
    - [x] Изменен input на select для назначения пользователя в `tasks.php`.
    - [x] Реализована функция `loadUsers()` в `js/tasks.js` для загрузки и отображения пользователей.
    - [x] Адаптирована логика модального окна редактирования задачи для работы с select.
- [~] Проанализировать `api/notifications.php` и связанный с ним `js/notifications.js` (основной функционал реализован, требуется рефакторинг `create_app_notification`):
    - [x] `api/notifications.php` (получение/отметка уведомлений) работает корректно.
    - [x] `js/notifications.js` (отображение, взаимодействие) работает корректно.
    - [x] Уведомление при добавлении участника на доску добавлено в `api/boards.php`.
    - [x] Рефакторинг функции `create_app_notification` (вынести в общий файл и подключить в `api/tasks.php` и `api/boards.php`).
- [ ] Просмотреть и проанализировать `TODO` комментарии в `api/tasks.php` и запланировать их выполнение.
- [ ] Просмотреть и проанализировать `TODO` комментарии в других файлах API и JS.
- [ ] Провести ревизию JS кода (`app.js`, `dashboard.js`, `tasks.js`, `theme.js`, `edit_board.js`, `notifications.js`) на предмет ошибок, улучшения читаемости (например, инкапсуляция глобальных функций) и использования `alert()`.
- [ ] Провести ревизию CSS (`style.css`, `theme.css`, `admin-styles.css`, `landing-page.css`) для улучшения внешнего вида и адаптивности.

## Ⅱ. Основные функциональные требования (на основе исходного todos.md и запроса)

### 1. Работа с досками задач
- **Создание досок:**
    - [~] Реализовать форму/интерфейс для создания новой доски (название, описание). (Частично есть в `dashboard.js` и `api/boards.php`)
    - [~] Реализовать логику PHP для сохранения новой доски в БД. (Частично есть)
    - [ ] Добавить/проверить поле "тип_доступа" (публичная/приватная) в БД и в логику создания. (Поле `is_private` есть в `schema.sql` и `api/boards.php`)
    - [ ] Связать создателя с приватной доской. (Поле `owner_id` есть)
- **Управление досками:**
    - [~] Реализовать интерфейс для редактирования названия и описания доски. (Есть `edit_board.php`, `edit_board.js`, `api/boards.php action=update`)
    - [~] Реализовать логику PHP для обновления данных доски. (Есть)
    - [~] Реализовать функцию удаления доски (с подтверждением). (Есть в `dashboard.js` и `api/boards.php`)
    - [~] Реализовать интерфейс для добавления участников команды к доске. (Есть в `api/boards.php action=add_member`, UI нужно проверить/доработать)
    - [~] Реализовать логику PHP для управления участниками доски (добавление, удаление). (Есть в `api/boards.php`)
- **Отображение досок:**
    - [~] Отображать список доступных досок на `dashboard.php`. (Есть)
    - [~] Учитывать права доступа (публичные/приватные/участник). (Логика есть в `api/boards.php action=get`)

### 2. Работа с карточками задач
- **Создание карточек:**
    - [~] Реализовать интерфейс для добавления карточек на доску. (Есть в `js/tasks.js` и `tasks.php`)
    - [~] Поля карточки: Название, Описание, Статус, Приоритет, Дедлайн. (Реализовано)
    - [~] Реализовать логику PHP для сохранения новой карточки. (Есть в `api/tasks.php action=create`)
- **Управление карточками:**
    - [~] Реализовать перетаскивание карточек между статусами. (Есть в `js/tasks.js`)
    - [~] Реализовать интерфейс для редактирования содержимого карточки (модальное окно). (Есть в `js/tasks.js`)
    - [~] Реализовать логику PHP для обновления данных карточки. (Есть в `api/tasks.php action=update_details`, `action=update_status`)
    - [~] Реализовать функцию удаления карточки. (Есть в `js/tasks.js` и `api/tasks.php action=delete`)
- **Отображение карточек:**
    - [~] Отображать карточки на доске, сгруппированные по статусам. (Есть в `js/tasks.js`)

### 3. Назначение задач участникам
- **Назначение задач:**
    - [~] Реализовать функционал для назначения задачи участнику. (Есть в модальном окне редактирования задачи в `js/tasks.js` и `api/tasks.php action=assign`)
    - [~] Логика PHP для сохранения назначенного пользователя. (Есть)
- **Отображение назначенных задач:**
    - [~] Пользователь должен видеть список задач, назначенных ему (фильтрация в `api/tasks.php action=get` для `participant_developer`).
- **Уведомления:**
    - [~] Реализовать уведомления в интерфейсе о новых назначениях/изменениях. (Уведомления создаются в `api/tasks.php` и `api/boards.php`. `js/notifications.js` и `api/notifications.php` для их обработки существуют. Требуется рефакторинг `create_app_notification` и полное тестирование).
        - [x] JavaScript для уведомлений (`js/notifications.js`) реализует `fetchUnreadNotifications`, `displayNotifications`, `markNotificationAsRead`, `markAllNotificationsAsRead`, периодический вызов.

### 4. Отслеживание прогресса
- **Обновление статуса:**
    - [~] Разработчик/участник может обновлять статус задачи. (Реализовано через drag-and-drop и select в `js/tasks.js`, `api/tasks.php action=update_status`)
- **Процентный индикатор:**
    - [~] Отображение прогресса выполнения задачи (0%, 50%, 100%). (Есть в `js/tasks.js` и `api/tasks.php`)

### 5. Роли пользователей и права доступа
- **Аутентификация и авторизация:**
    - [x] Улучшить обработку ошибок в `api/auth.php` (использование сессии для передачи ошибок).
    - [x] Отображать ошибки аутентификации на страницах `login.php` и `register.php`.
    - [x] Добавить проверку подтверждения пароля и минимальной длины пароля в `api/auth.php`.
    - [x] Реализовать автоматический вход пользователя после успешной регистрации в `api/auth.php`.
    - [x] Проверить и доработать `logout.php`. (Корректно)
    - [~] Роли (`user`, `manager`, `developer`) есть в `schema.sql`.
- **Права доступа:**
    - [~] Реализована базовая проверка ролей и прав в API (`api/boards.php`, `api/tasks.php`).
    - [ ] **Детальная проверка и доработка прав для каждой роли и действия согласно требованиям:**
        - **Пользователь:** Создание досок/карточек, просмотр своих задач.
        - **Менеджер:** Все права пользователя + назначение задач, просмотр общего прогресса. (Частично есть, `api/tasks.php` упоминает менеджера)
        - **Разработчик:** Все права пользователя + обновление статуса своих задач, просмотр своих задач. (Частично есть)
    - [ ] Убедиться в консистентности применения прав во всех API-эндпоинтах.

## IV. Улучшения и исправления (помимо TODO из кода)
- [~] Диаграмма Ганта. (Реализована в `js/tasks.js` с Frappe Gantt)
- [ ] Проверить безопасность (SQL-инъекции, XSS). (PDO используется, XSS требует проверки вывода на клиенте).
- [ ] Оптимизировать запросы к БД, где это возможно.
- [ ] Улучшить обработку ошибок и обратную связь с пользователем (вместо `alert()`).
- [ ] Рассмотреть возможность рефакторинга длинных API файлов (например, `api/tasks.php`, `api/boards.php`) для лучшей читаемости/поддержки.
- [ ] Решить проблему с закомментированным `loadUsers()` в `js/tasks.js` (проверить `api/users.php?action=get`).
